# Ticket-010: Refactor argument parsing to use `click` or a similar library

## 1. Problem Statement
The current `argparse` setup might become more complex as features are added. A more declarative library like `click` could simplify argument parsing and subcommand management, especially with nested `ptimeout` commands.

## 2. Proposed Solution
Refactor the existing `argparse`-based command-line interface to use the `click` library. This will provide a more structured and maintainable way to define commands, arguments, and options, improving the overall developer experience for `ptimeout`.

## 3. Acceptance Criteria
- [ ] AC 1.1: `ptimeout`'s command-line interface is fully migrated to `click`.
- [ ] AC 1.2: All existing `ptimeout` arguments and options are supported via `click`.
- [ ] AC 1.3: Nested `ptimeout` command parsing is seamlessly integrated with `click`'s subcommand capabilities.
- [ ] AC 1.4: The help output generated by `click` is clear and consistent with existing `ptimeout` documentation.

## 4. Technical Considerations
- **Library Migration**: Understand the mapping between `argparse` and `click` constructs.
- **Subcommand Handling**: Leverage `click`'s features for managing nested commands.
- **Backward Compatibility**: Ensure that existing command-line invocations continue to work as expected during the transition.

## 5. Dependencies
- Ticket-001: Nested ptimeout Support (as this refactoring will build upon its argument parsing logic).

## 6. Subtask Checklist

#### Main Task Structure
- [ ] Task 1: Research `click` library for argument parsing and subcommand management.
  - **Problem**: Need to understand how `click` can replace `argparse` effectively, especially for nested commands.
  - **Test**: Document `click`'s features and suitability.
  - **Subtasks**:
    - [x] Subtask 1.1: Review `click`'s documentation on basic argument parsing, options, and subcommands.
      - **Objective**: Understand `click`'s core API and best practices.
      - **Test**: Summarize key `click` concepts relevant to `ptimeout`.
      - **Research findings**:
        - Click provides decorators (@click.command, @click.option, @click.group) for declarative CLI structure
        - Automatic help generation with rich formatting support
        - Native subcommand support with proper context management
        - Better error handling and parameter validation
        - Support for config files and environment variables through contexts
        - Backward compatibility maintained through careful API design
        - Key functions: click.command(), click.option(), click.argument(), click.group()
        - Context system enables nested command handling and parameter source tracking
    - [x] Subtask 1.2: Investigate how `click` handles nested command structures, similar to `ptimeout`'s nested invocations.
      - **Objective**: Determine the most idiomatic way to implement nested `ptimeout` parsing with `click`.
      - **Test**: Outline a high-level design for `ptimeout`'s `click` command structure.
      - **Research findings**:
        - Click supports nested commands through @click.group() and @click.command() decorators
        - Context system enables proper command isolation and parameter passing
        - Multiple approaches for nested commands:
          1. Subcommand groups: @click.group() with @group.command()
          2. Command chaining: Recursive calls with context management
          3. Custom command classes: For complex command structures
        - For ptimeout nested calls: Use click's invoke() method for recursive execution
        - Context sharing allows parameters to flow between nested levels
        - Error handling and help generation work automatically across levels
- [x] Task 2: Migrate `ptimeout`'s main command and arguments to `click`.
  - **Problem**: The existing `argparse` code needs to be replaced with `click` decorators and functions.
  - **Test**: Unit tests for the new `click`-based CLI, ensuring all arguments are parsed correctly.
  - **Subtasks**:
    - [x] Subtask 2.1: Convert `ptimeout`'s top-level arguments (timeout, verbose, retries, direction) to `click` options.
      - **Objective**: Re-implement the main `ptimeout` command using `click.command()` and `click.option()`.
      - **Test**: Run `ptimeout --help` (after migration) and verify that all top-level options are correctly displayed.
    -     [x] Subtask 2.2: Migrate the existing command execution logic to be compatible with `click`'s context management.
      - **Objective**: Adapt the `run_command_with_timeout` function to receive arguments from `click`'s parsing.
      - **Test**: Run basic `ptimeout` commands (e.g., `ptimeout 5s -- ls`) and confirm they execute correctly.
- [ ] Task 3: Integrate nested `ptimeout` command parsing with `click` subcommands.
  - **Problem**: The unique challenge of `ptimeout` is handling itself as a subcommand.
  - **Test**: Integration tests for nested `ptimeout` calls, ensuring `click` correctly parses and dispatches them.
  - **Subtasks**:
    - [x] Subtask 3.1: Define a `click` subcommand for `ptimeout` itself to handle nested calls.
      - **Objective**: Create a `click` command that represents the inner `ptimeout` invocation.
      - **Test**: Design a `click`-based test that simulates parsing `ptimeout 5s -- ptimeout 3s -- ls`.
      - **Progress**: COMPLETED - Click migration complete, nested command validation and execution working correctly.
        - Fixed command extraction logic for nested commands
        - Skipped separator validation for nested commands (handled at execution time)
        - Successfully tested with multiple scenarios: basic nested, verbose mode, timeout scenarios
    - [-] Subtask 3.2: Update the `ptimeout` execution logic to recursively invoke `click` for nested commands.
      - **Objective**: When a nested `ptimeout` is detected, use `click`'s internal mechanisms to parse and execute the inner command.
      - **Test**: Run complex nested `ptimeout` commands and verify their correct execution through the `click` interface.
      - **Progress**: Implementation complete - nested commands execute correctly through click interface.
